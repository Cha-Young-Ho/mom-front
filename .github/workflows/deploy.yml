name: Deploy React App to S3

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3 ë“±ì˜ íƒœê·¸ í‘¸ì‹œ ì‹œ íŠ¸ë¦¬ê±°
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  AWS_REGION: ap-northeast-2  # ì›í•˜ëŠ” AWS ë¦¬ì „ìœ¼ë¡œ ë³€ê²½
  S3_BUCKET: ${{ secrets.S3_BUCKET || 'your-bucket-name-here' }}  # S3 ë²„í‚· ì´ë¦„
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID || 'E1234567890ABC' }}  # CloudFront ë°°í¬ ID

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # OIDCì— í•„ìš”í•œ ê¶Œí•œ
      contents: read    # ì½”ë“œ ì²´í¬ì•„ì›ƒì— í•„ìš”í•œ ê¶Œí•œ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract version from tag
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # v1.0.0 -> 1.0.0
        else
          TAG_NAME="manual-deploy"
          VERSION="latest"
        fi
        
        echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        echo "ðŸ·ï¸ Tag: $TAG_NAME"
        echo "ðŸ“¦ Version: $VERSION"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --production=false
        echo "âœ… Dependencies installed"

    - name: Run code quality checks
      run: |
        echo "ðŸ” Running code quality checks..."
        npm run lint
        npm run type-check
        echo "âœ… Code quality checks passed"

    - name: Create production environment file
      run: |
        echo "REACT_APP_VERSION=${{ steps.version.outputs.version }}" >> .env.production
        echo "REACT_APP_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .env.production
        echo "REACT_APP_ENVIRONMENT=production" >> .env.production
        # ì¶”ê°€ í™˜ê²½ ë³€ìˆ˜ê°€ ìžˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
        echo "ðŸ”§ Production environment variables created"

    - name: Build React app
      run: |
        echo "ðŸ”¨ Building React application..."
        npm run build
        echo "âœ… Build completed successfully"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      run: |
        echo "â˜ï¸ Deploying to S3 bucket: ${{ env.S3_BUCKET }}"
        
        # ë°°í¬ ì „ ë²„í‚· ì¡´ìž¬ í™•ì¸
        if ! aws s3 ls s3://${{ env.S3_BUCKET }} > /dev/null 2>&1; then
          echo "âŒ Error: S3 bucket '${{ env.S3_BUCKET }}' does not exist or is not accessible"
          exit 1
        fi
        
        # ì •ì  assets (JS, CSS, ì´ë¯¸ì§€ ë“±)ì— ëŒ€í•œ ìºì‹œ ì„¤ì • (1ë…„)
        echo "ðŸ“¤ Uploading static assets with long-term caching..."
        aws s3 sync build/ s3://${{ env.S3_BUCKET }}/ \
          --delete \
          --cache-control "max-age=31536000, immutable" \
          --exclude "*.html" \
          --exclude "service-worker.js" \
          --exclude "manifest.json" \
          --exclude "robots.txt" \
          --exclude "*.map"
        
        # HTML íŒŒì¼ê³¼ ì„œë¹„ìŠ¤ ì›Œì»¤ëŠ” ìºì‹œí•˜ì§€ ì•ŠìŒ
        echo "ðŸ“„ Uploading HTML and service worker files with no-cache..."
        aws s3 sync build/ s3://${{ env.S3_BUCKET }}/ \
          --cache-control "no-cache, no-store, must-revalidate" \
          --include "*.html" \
          --include "service-worker.js" \
          --include "manifest.json" \
          --include "robots.txt"
        
        # Source map íŒŒì¼ë“¤ì€ ë³„ë„ ì²˜ë¦¬ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ì œì™¸í•  ìˆ˜ ìžˆìŒ)
        echo "ðŸ—ºï¸ Uploading source maps..."
        aws s3 sync build/ s3://${{ env.S3_BUCKET }}/ \
          --cache-control "max-age=31536000" \
          --include "*.map"
        
        echo "âœ… S3 deployment completed"

    - name: Invalidate CloudFront
      if: env.CLOUDFRONT_DISTRIBUTION_ID != 'E1234567890ABC' && env.CLOUDFRONT_DISTRIBUTION_ID != ''
      run: |
        echo "ðŸ”„ Invalidating CloudFront distribution: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
        
        # CloudFront ë°°í¬ ìƒíƒœ í™•ì¸
        DISTRIBUTION_STATUS=$(aws cloudfront get-distribution \
          --id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
          --query 'Distribution.Status' \
          --output text)
        
        if [ "$DISTRIBUTION_STATUS" != "Deployed" ]; then
          echo "âš ï¸ Warning: Distribution is in '$DISTRIBUTION_STATUS' state. Proceeding with invalidation..."
        fi
        
        # ë¬´íš¨í™” ìƒì„±
        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*" \
          --query 'Invalidation.Id' \
          --output text)
        
        echo "ðŸ”„ Invalidation created with ID: $INVALIDATION_ID"
        echo "â³ Waiting for invalidation to complete..."
        
        # ë¬´íš¨í™” ì™„ë£Œ ëŒ€ê¸° (íƒ€ìž„ì•„ì›ƒ 15ë¶„)
        timeout 900 aws cloudfront wait invalidation-completed \
          --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
          --id $INVALIDATION_ID || {
            echo "âš ï¸ Invalidation is taking longer than expected, but deployment continues..."
            echo "ðŸ”— Check invalidation status at: https://console.aws.amazon.com/cloudfront/"
            exit 0
          }
        
        echo "âœ… CloudFront invalidation completed"

    - name: Get deployment URLs
      id: deployment-urls
      run: |
        S3_WEBSITE_URL="https://${{ env.S3_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
        echo "s3-website-url=$S3_WEBSITE_URL" >> $GITHUB_OUTPUT
        
        if [[ "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" != "E1234567890ABC" && "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" != "" ]]; then
          CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
            --id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --query 'Distribution.DomainName' \
            --output text)
          CLOUDFRONT_URL="https://$CLOUDFRONT_DOMAIN"
          echo "cloudfront-url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ CloudFront URL: $CLOUDFRONT_URL"
        fi
        
        echo "ðŸŒ S3 Website URL: $S3_WEBSITE_URL"

    - name: Create deployment summary
      run: |
        echo "ðŸŽ‰ React ì•± ë°°í¬ ì™„ë£Œ!"
        echo "ðŸ“‹ ë°°í¬ ì •ë³´:"
        echo "   ðŸ“¦ Tag: ${{ steps.version.outputs.tag }}"
        echo "   ðŸ”¢ Version: ${{ steps.version.outputs.version }}"
        echo "   â˜ï¸ S3 Bucket: ${{ env.S3_BUCKET }}"
        echo "   ðŸŒ AWS Region: ${{ env.AWS_REGION }}"
        echo "   â° Deploy Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "ðŸ”— ì ‘ì† URL:"
        echo "   ðŸ“„ S3 Website: ${{ steps.deployment-urls.outputs.s3-website-url }}"
        
        if [[ "${{ steps.deployment-urls.outputs.cloudfront-url }}" != "" ]]; then
          echo "   âš¡ CloudFront CDN: ${{ steps.deployment-urls.outputs.cloudfront-url }}"
          echo "   ðŸ”„ Distribution ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
        fi
        
        echo ""
        echo "ðŸ“Š ë°°í¬ í†µê³„:"
        BUILD_SIZE=$(du -sh build/ | cut -f1)
        FILE_COUNT=$(find build/ -type f | wc -l | tr -d ' ')
        echo "   ðŸ“ Build Size: $BUILD_SIZE"
        echo "   ðŸ“„ File Count: $FILE_COUNT files"
        
        echo ""
        echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        
        # GitHub Summaryì— ê²°ê³¼ ê¸°ë¡
        {
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ"
          echo ""
          echo "| í•­ëª© | ê°’ |"
          echo "|------|-----|"
          echo "| ðŸ“¦ Tag | ${{ steps.version.outputs.tag }} |"
          echo "| ðŸ”¢ Version | ${{ steps.version.outputs.version }} |"
          echo "| â˜ï¸ S3 Bucket | ${{ env.S3_BUCKET }} |"
          echo "| ðŸŒ Region | ${{ env.AWS_REGION }} |"
          echo "| â° Deploy Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |"
          echo "| ðŸ“ Build Size | $BUILD_SIZE |"
          echo "| ðŸ“„ File Count | $FILE_COUNT files |"
          echo ""
          echo "### ðŸ”— ì ‘ì† URL"
          echo "- ðŸ“„ [S3 Website](${{ steps.deployment-urls.outputs.s3-website-url }})"
          if [[ "${{ steps.deployment-urls.outputs.cloudfront-url }}" != "" ]]; then
            echo "- âš¡ [CloudFront CDN](${{ steps.deployment-urls.outputs.cloudfront-url }})"
          fi
        } >> $GITHUB_STEP_SUMMARY
